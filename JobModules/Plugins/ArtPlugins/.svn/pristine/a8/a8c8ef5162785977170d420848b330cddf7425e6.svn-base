using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using UnityEditor;
using UnityEditor.SceneManagement;
using UnityEngine;
using UnityEngine.SceneManagement;

public static class BakeOc
{
    public static bool LoadScenes(IList<string> bundles, IList<string> scenes)
    {
        if (bundles.Count < 2 || scenes.Count < 2 || bundles.Count != scenes.Count)
        {
            Debug.LogErrorFormat("Invalid OC scene parameter, bundle count: {0}, scene count: {1}", bundles.Count, scenes.Count);
            return false;
        }

        List<string> scenePath = new List<string>();

        for (int i = 0; i < bundles.Count; i++)
        {
            var availableScenes = AssetDatabase.GetAssetPathsFromAssetBundleAndAssetName(bundles[i], scenes[i]);
            if (availableScenes != null && availableScenes.Length > 0)
                scenePath.Add(availableScenes[0]);
            else
                return false;
        }

        EditorSceneManager.OpenScene(scenePath[0], OpenSceneMode.Single);

        EditorSceneManager.sceneOpened += OnSceneOpened;

        for (int i = 1; i < scenePath.Count; i++)
            EditorSceneManager.OpenScene(scenePath[i], OpenSceneMode.Additive);

        EditorSceneManager.sceneOpened -= OnSceneOpened;

        return true;
    }

    public static void Bake()
    {
        StaticOcclusionCulling.Clear();
        StaticOcclusionCulling.Compute();

        EditorSceneManager.SaveOpenScenes();
    }

    private static void OnSceneOpened(Scene scene, OpenSceneMode mode)
    {
        foreach (var go in scene.GetRootGameObjects())
        {
            SetOcclusionFlag(go);
        }
    }

    private static void SetOcclusionFlag(GameObject go)
    {
        var renderer = go.GetComponent<MeshRenderer>();
        if (renderer != null)
            GameObjectUtility.SetStaticEditorFlags(go, GameObjectUtility.GetStaticEditorFlags(go) | StaticEditorFlags.OccluderStatic | StaticEditorFlags.OccludeeStatic);

        for (int i = 0; i < go.transform.childCount; i++)
            SetOcclusionFlag(go.transform.GetChild(i).gameObject);
    }
}
